rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 游댳 Permitir a los usuarios autenticados leer TODAS las "userCards" pero escribir solo en las suyas
    match /userCards/{documentId} {
      allow read: if request.auth != null;
             // 游댳 Permitir que el usuario due침o pueda modificar su propia tarjeta (incluyendo direcci칩n y geolocalizaci칩n)
      allow write: if request.auth != null && request.auth.uid == documentId;
    }

    // 游댳 Permitir a los usuarios autenticados leer su propio perfil y a los conductores leer los perfiles de los usuarios
    match /usuarios/{userId} {
      allow read: if request.auth != null;  // Todos los autenticados pueden leer (usuarios y conductores)
      allow write: if request.auth != null && request.auth.uid == userId; // Solo el usuario due침o puede editar
    }

    // 游댳 Permitir a los conductores autenticados leer su perfil y a los usuarios ver la info de los conductores
    match /conductores/{driverId} {
      allow read: if request.auth != null; // Todos los autenticados pueden leer (usuarios y conductores)
      allow write: if request.auth != null && request.auth.uid == driverId; // Solo el conductor due침o puede editar
    }

    // 游댳 Modificaci칩n en requests para permitir que los conductores asignen una solicitud a s칤 mismos
    match /requests/{requestId} {
      allow read: if request.auth != null; 
      
      allow write: if request.auth != null && (
        request.auth.uid == request.resource.data.userId || 
        request.auth.uid == request.resource.data.assignedDriver ||
        
        // 游댳 Permitir que un conductor asigne la solicitud si a칰n no hay conductor asignado
        (!exists(request.resource.data.assignedDriver) || request.resource.data.assignedDriver == null)
      );
    }
  }
}
